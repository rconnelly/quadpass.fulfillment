doctype 5
html(lang='en')
    head
        meta(charset='utf-8')
        meta(http-equiv='X-UA-Compatible', content='IE=edge,chrome=1')
        - var titleName = (page.title) ? meta.title + ' / ' + page.title : meta.title
        title= titleName
        meta(name='description', content='#{meta.desc}')
        meta(name='author', content='#{meta.author.name}')
        link(type='text/plan', rel='author', href='#{meta.author.url}')
        meta(name='viewport', content='width=device-width,initial-scale=1')

        block headerContent

        style(type='text/css')
            img.listing { float: left; margin-right: 10px; }
            .listing span.review_count { display: block; float: right; }

        if bootstrap
            link(rel='stylesheet', href='/libs/bootstrap/css/bootstrap.min.css')
            link(rel='stylesheet', href='/assets/style.css')
        each ss in stylesheets
                link(rel='stylesheet', href=ss)

        script
                window.CLIENTAPP = {
                    genTime: #{Date.now()},
                    onload: []
                  };

        style(type="text/css")
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
            .btn-next {
                width: 150px !important;
            }

    - var bodyClass = page.className + bootstrap ? ' bootstrap':''
    body(class='#{bodyClass}')

        if bootstrap
            include includes/_navbar

        if jquery
            script(src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js')

            script $.ajaxSetup({ cache: false, data: { _csrf: "#{req.session._csrf}" } });

        .container
            block content

        if bootstrap
            include includes/_footer

        if jquery && bootstrap
            script(src='/libs/bootstrap/js/bootstrap.js')

        script
            // flash messages
            (function(all) {

                if(new Date() - new Date(CLIENTAPP.genTime) > 10000) {
                  return; // 10 seconds since genTime - probably back btn nav - dont show messages again
                }

                var $c = false;

                if(window.jQuery && $('body').is('.bootstrap')) {
                  $c = $('#messages');
                  if(!$c.size()) {
                    $c = $('<div id="messages" />').prependTo('#main');
                  }
                }

                window.flashMessage = function(type, msg, noclear) {
                  if($c) {
                    if(!noclear) {
                      $c.empty();
                    }
                    $c.append(
                      $('<div class="alert fade in"></div>')
                        .text(msg)
                        .append('<a class="close" href="#" data-dismiss="alert">Ã—</a>')
                        .addClass('alert-'+type)
                        .alert() // bootstrap-alerts.js
                    );
                  }
                  else {
                    alert('['+type+'] '+msg);
                  }
                }

                for (var type in all) {
                  var msgs = all[type];
                  for (var i=0; i < msgs.length; i++) {
                    flashMessage(type, msgs[i], true);
                  };
                };

                // messages can be stored locally to be displayed after a page refresh...
                var domStore = JSON && JSON.stringify && window.localStorage, // browser must be modern!
                    KEY = 'flash';

                window.storeFlashMessage = function(type, msg) {
                  if(domStore) {
                    var str = domStore.getItem(KEY),
                        set = str ? JSON.parse(str) : [];
                    set.push({type:type, msg:msg});
                    domStore.removeItem(KEY); // workaround QUOTA_EXCEEDED_ERR
                    domStore.setItem(KEY, JSON.stringify(set));
                  }
                  else {
                    flashMessage(type, msg);
                  }
                }

                if(domStore) {
                  var str = domStore.getItem(KEY),
                      set = str ? JSON.parse(str) : [];
                  for (var i=0; i < set.length; i++) {
                    flashMessage(set[i].type, set[i].msg, true);
                  };
                  domStore.removeItem(KEY);
                }

              })(#{JSON.stringify(req.flash())});

        each script in scripts
            script(src=script)

        script
            (function(o) {
              for (var i=0, m=o.length; i < m; i++) {
                o[i].call();
              };
            })(CLIENTAPP.onload);